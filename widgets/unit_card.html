<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Card</title>
  <style>
    :root{
      --text:#0b1220;
      --white:#fff;
      --muted: rgba(255,255,255,.82);
      --shadowSoft: 0 14px 34px rgba(0,0,0,.14);
      --radius: 34px;
      --btnText: #111827;
      --focus: rgba(255,255,255,.25);
      --border: rgba(17,24,39,.12);
      --divider: rgba(17,24,39,.10);
      --modalText: #111827;
      --modalMuted: #6b7280;
    }

    html,
    *{box-sizing:border-box}
    html{ background: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: transparent;
      color: var(--text);
      padding: 0;
    }

    .cards-container{
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0;
      background: transparent;
    }

    #root{
      background: transparent;
      padding: 0;
      border: 0;
      border-radius: 0;
    }

    @supports not (gap: 1rem) {
      .room-card + .room-card{ margin-top: 16px; }
    }

    .room-card{
      width: 100%;
      border-radius: var(--radius);
      overflow:hidden;
      position:relative;
      background:#111;
    }

    .room-media{
      position:relative;
      height: 420px;
      background:
        radial-gradient(1200px 700px at 75% 15%, rgba(255,255,255,.20), rgba(255,255,255,0) 55%),
        linear-gradient(135deg, #101827 0%, #2a3f67 48%, #c89b57 100%);
    }

    .room-media::before{
      content:"";
      position:absolute;
      inset:0;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      pointer-events:none;
    }

    .room-media::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,0) 30%, rgba(0,0,0,.55) 100%);
      pointer-events:none;
    }

    .content{
      position:absolute;
      left: 26px;
      right: 26px;
      bottom: 22px;
      color: var(--white);
      display:flex;
      flex-direction:column;
      gap: 14px;
      z-index: 1;
    }

    .title{
      margin:0;
      font-size: clamp(28px, 3.2vw, 44px);
      line-height:1.05;
      letter-spacing:-.6px;
      font-weight: 900;
      text-shadow: 0 14px 40px rgba(0,0,0,.45);
    }

    .subtitle{
      margin:0;
      font-size: 18px;
      font-weight: 650;
      color: var(--muted);
      letter-spacing:-.2px;
      text-shadow: 0 12px 34px rgba(0,0,0,.38);
    }

    .amenities{
      display:flex;
      align-items:center;
      gap: 14px;
      flex-wrap:wrap;
      font-size: 18px;
      font-weight: 650;
      color: rgba(255,255,255,.85);
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .amenities .item{
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }

    .amenities svg{
      width: 20px;
      height: 20px;
      opacity: .9;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    .divider{
      width:1px;
      height: 18px;
      background: rgba(255,255,255,.28);
      border-radius: 999px;
      margin: 0 4px;
    }

    .cta-row{
      display:flex;
      gap: 16px;
      align-items:center;
      margin-top: 4px;
    }

    .price-pill{
      height: 68px;
      min-width: 180px;
      padding: 0 20px;
      border-radius: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadowSoft);
      font-weight: 950;
      letter-spacing: -0.4px;
      font-size: 38px;
    }

    .cta-buttons{
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .reserve,
    .details{
      height: 68px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: var(--shadowSoft);
      font-weight: 900;
      font-size: 22px;
      letter-spacing: -0.2px;
      cursor:pointer;
      transition: transform .15s ease;
    }

    .reserve{
      flex: 1;
      background: rgba(255,255,255,.94);
      color: var(--btnText);
    }

    .details{
      min-width: 190px;
      padding: 0 24px;
      background: rgba(17,24,39,.42);
      color: #fff;
    }

    .reserve:hover,
    .details:hover{ transform: translateY(-1px); }

    .reserve:active,
    .details:active{ transform: translateY(0px); }

    .reserve:focus,
    .details:focus{
      outline:none;
      box-shadow: 0 0 0 5px var(--focus), var(--shadowSoft);
    }

    .reserve:disabled,
    .details:disabled{
      cursor: wait;
      opacity: .85;
      transform: none;
    }

    .room-card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: var(--radius);
      pointer-events:none;
      border: 1px solid rgba(255,255,255,.10);
    }

    .type-badge,
    .guests-badge{
      position: absolute;
      top: 16px;
      z-index: 2;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:#fff;
      font-weight: 700;
      font-size: 14px;
      text-shadow: 0 4px 12px rgba(0,0,0,.3);
    }

    .type-badge{ left: 16px; }
    .guests-badge{ right: 16px; }
    .guests-badge svg{ width:16px; height:16px; }

    dialog{
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 18px;
      max-width: 560px;
      width: calc(100% - 28px);
      box-shadow: 0 24px 60px rgba(0,0,0,.18);
      color: var(--modalText);
    }

    dialog::backdrop{
      background: rgba(17,24,39,.45);
      backdrop-filter: blur(2px);
    }

    .modal-title{ margin:0 0 10px 0; font-size:18px; font-weight: 950; }
    .modal-text{ margin:0; color: var(--modalMuted); font-weight: 650; line-height: 1.55; }
    .modal-actions{ margin-top:14px; display:flex; justify-content:flex-end; gap:10px; }
    .close{
      height: 44px;
      padding: 0 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,.04);
      font-weight: 950;
      cursor:pointer;
    }

    #detailsDialog{
      max-width: min(1140px, calc(100% - 20px));
      width: min(1140px, calc(100% - 20px));
      padding: 0;
      overflow: hidden;
      border-radius: 24px;
      background: #fff;
    }

    .details-shell{
      max-height: min(88vh, 980px);
      overflow-y: auto;
      padding: 22px;
      color: #111827;
    }

    .details-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .details-title{
      margin: 0;
      font-size: clamp(26px, 2.8vw, 44px);
      line-height: 1.05;
      letter-spacing: -.5px;
      font-weight: 900;
    }

    .details-subtitle{
      margin: 6px 0 0 0;
      color: #4b5563;
      font-size: 18px;
      font-weight: 700;
    }

    .details-section{
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--divider);
    }

    .details-section h3{
      margin: 0 0 12px 0;
      font-size: 32px;
      letter-spacing: -.2px;
      font-weight: 900;
    }

    .details-gallery{
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 10px;
      margin-top: 8px;
    }

    .details-gallery-main,
    .details-gallery-side-item{
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: #eef2f7;
    }

    .details-gallery-main{ aspect-ratio: 1 / 1; }

    .details-gallery-side{
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
    }

    .details-gallery-side-item{ aspect-ratio: 1 / 1; }

    .details-gallery img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .details-description{
      margin: 0;
      color: #374151;
      font-size: 17px;
      line-height: 1.6;
      font-weight: 600;
      white-space: pre-wrap;
    }

    .review-inline{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
      font-weight: 800;
      color: #111827;
    }

    .review-inline svg{
      width: 18px;
      height: 18px;
    }

    .amenities-grid{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
    }

    .amenity-item{
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 17px;
      font-weight: 700;
      color: #1f2937;
    }

    .amenity-item svg{
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
      color: #374151;
    }

    .reviews-list{
      display: grid;
      gap: 12px;
    }

    .review-card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(17,24,39,.02);
    }

    .review-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .review-author{
      font-weight: 900;
      font-size: 16px;
    }

    .review-meta{
      color: #4b5563;
      font-weight: 700;
      font-size: 13px;
    }

    .review-comment{
      margin: 0;
      color: #374151;
      font-size: 15px;
      line-height: 1.5;
      font-weight: 600;
    }

    .details-empty{
      color: #6b7280;
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }

    .map-wrap{
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: #f3f4f6;
      aspect-ratio: 16 / 9;
      min-height: 240px;
    }

    .map-wrap iframe{
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    .host-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .host-card,
    .host-meta-card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: rgba(17,24,39,.02);
    }

    .host-id{
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .host-avatar{
      width: 68px;
      height: 68px;
      border-radius: 999px;
      object-fit: cover;
      background: #e5e7eb;
    }

    .host-name{ margin:0; font-size: 22px; font-weight: 900; letter-spacing: -.2px; }
    .host-small{ margin: 4px 0 0 0; color:#6b7280; font-weight:700; font-size: 14px; }

    .host-badges{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .host-badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 800;
      font-size: 13px;
      color: #374151;
    }

    .things-tabs{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .thing-tab{
      height: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,.04);
      color: #111827;
      font-weight: 850;
      cursor: pointer;
    }

    .thing-tab.active{
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .thing-content{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: rgba(17,24,39,.02);
      color: #374151;
      font-size: 16px;
      line-height: 1.6;
      font-weight: 650;
      min-height: 100px;
    }

    .details-reserve-row{
      margin-top: 24px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .details-reserve{
      min-width: 220px;
      height: 56px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 16px 30px rgba(17,24,39,.18);
    }

    .details-reserve:disabled{
      opacity: .75;
      cursor: wait;
    }

    #loading{
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      font-size: 16px;
      font-weight: 600;
    }

    .retry-btn{
      margin-top: 14px;
      border: 1px solid rgba(17,24,39,.14);
      background: #fff;
      color: #111827;
      border-radius: 999px;
      height: 40px;
      padding: 0 16px;
      font-weight: 800;
      cursor: pointer;
    }

    .reserve-error{
      display: none;
      width: min(1120px, calc(100% - 24px));
      margin: 8px auto 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.22);
      color: #991b1b;
      font-size: 14px;
      font-weight: 700;
    }

    .reserve-error.show{ display: block; }

    @media (max-width: 920px){
      .room-media{height: 380px;}
      .content{left: 18px; right: 18px; bottom: 18px;}
      .price-pill{min-width: 150px; height: 60px; font-size: 32px;}
      .reserve,
      .details{height: 60px; font-size: 20px;}
      .amenities{font-size: 16px;}
      #detailsDialog{width: calc(100% - 12px);} 
      .details-shell{padding: 16px;}
      .details-section h3{font-size: 26px;}
      .host-grid{grid-template-columns: 1fr;}
    }

    @media (max-width: 680px){
      .cta-row{flex-direction: column; align-items: stretch;}
      .price-pill{width: 100%;}
      .cta-buttons{width: 100%;}
      .reserve,
      .details{flex: 1; min-width: 0; font-size: 18px;}
      .amenities{gap: 10px;}
      .divider{display:none;}
      .details-gallery{grid-template-columns: 1fr;}
      .details-gallery-side{grid-template-columns: 1fr 1fr; grid-template-rows: 1fr;}
      .amenities-grid{grid-template-columns: 1fr;}
      .details-reserve-row{justify-content: stretch;}
      .details-reserve{width: 100%;}
      .details-title{font-size: 32px;}
    }
  </style>
</head>
<body>
  <div id="reserveError" class="reserve-error" role="alert"></div>
  <div id="root"><div id="loading">Loading rooms...</div></div>

  <dialog id="detailsDialog" aria-label="Room details">
    <div id="detailsDialogContent" class="details-shell"></div>
  </dialog>

  <script>
    const ICONS = {
      bed: `<svg viewBox="0 0 24 24" fill="none"><path d="M4 10h16v8H4v-8z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M4 10V8a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 18v2M4 18v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      bath: `<svg viewBox="0 0 24 24" fill="none"><path d="M7 7a3 3 0 0 1 6 0v7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 14h16v2a5 5 0 0 1-5 5H9a5 5 0 0 1-5-5v-2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M6 21v-2M18 21v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      guest: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/><path d="M5 20c0-3.3 2.7-6 7-6s7 2.7 7 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      star: `<svg viewBox="0 0 24 24" fill="none"><path d="M12 17.3l-6.18 3.25 1.18-6.9L1.99 8.98l6.92-1L12 1.7l3.09 6.28 6.92 1-5.01 4.67 1.18 6.9L12 17.3z" fill="currentColor"/></svg>`,
      wifi: `<svg viewBox="0 0 24 24" fill="none"><path d="M2 8c5.5-4 14.5-4 20 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M5 12c4-3 10-3 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 16c2.5-2 5.5-2 8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="19" r="1.2" fill="currentColor"/></svg>`,
      kitchen: `<svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2"/><path d="M9 4v16M4 10h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      parking: `<svg viewBox="0 0 24 24" fill="none"><path d="M5 4h6a4 4 0 0 1 0 8H5z" stroke="currentColor" stroke-width="2"/><path d="M5 12v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      water: `<svg viewBox="0 0 24 24" fill="none"><path d="M12 3c2.5 3.2 5 6.1 5 9a5 5 0 0 1-10 0c0-2.9 2.5-5.8 5-9z" stroke="currentColor" stroke-width="2"/></svg>`,
      washer: `<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="3" width="16" height="18" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2"/><path d="M8 6h1M11 6h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
      shield: `<svg viewBox="0 0 24 24" fill="none"><path d="M12 3l7 3v6c0 4.8-3 7.7-7 9-4-1.3-7-4.2-7-9V6l7-3z" stroke="currentColor" stroke-width="2"/></svg>`,
      check: `<svg viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    };

    const RESERVE_CALL_TIMEOUT_MS = 10000;
    const RESERVE_CALL_ERROR_TEXT = 'Unable to open booking form. Please try Reserve again.';

    let hydrated = false;
    let hydrationTimeoutId = null;
    let hydrationPollId = null;

    let currentUnits = [];
    let unitsById = new Map();
    let currentBookingContext = { check_in: '', check_out: '', guests: 2 };

    let detailsUnitId = '';
    let detailsThingsToKnow = {};
    let detailsActiveThingTab = 'cancellation';

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function sanitizeUrl(raw) {
      const value = String(raw || '').trim();
      if (!/^https?:\/\//i.test(value)) return '';
      return value.replace(/"/g, '%22').replace(/'/g, '%27');
    }

    function formatMultilineText(value) {
      return escapeHtml(value || '').replace(/\n/g, '<br>');
    }

    function getReserveButton(unitId) {
      if (!unitId) return null;
      return document.querySelector(`.room-card[data-unit-id="${unitId}"] .reserve`);
    }

    function getDetailsReserveButton() {
      return document.getElementById('detailsReserveBtn');
    }

    function setReserveButtonState(unitId, opening) {
      const btn = getReserveButton(unitId);
      if (btn) {
        btn.disabled = opening;
        btn.textContent = opening ? 'Opening...' : 'Reserve';
      }

      if (detailsUnitId && detailsUnitId === unitId) {
        const detailsBtn = getDetailsReserveButton();
        if (detailsBtn) {
          detailsBtn.disabled = opening;
          detailsBtn.textContent = opening ? 'Opening...' : 'Reserve';
        }
      }
    }

    function clearReserveError() {
      const el = document.getElementById('reserveError');
      if (!el) return;
      el.textContent = '';
      el.classList.remove('show');
    }

    function showReserveError(message) {
      const el = document.getElementById('reserveError');
      if (!el) return;
      el.textContent = message;
      el.classList.add('show');
    }

    function isStructuredBookingPayload(data) {
      return !!data &&
        typeof data === 'object' &&
        typeof data.unit_id === 'string' &&
        typeof data.check_in === 'string' &&
        typeof data.check_out === 'string';
    }

    function normalizeBookingPayload(raw) {
      const sources = [];

      if (raw && typeof raw === 'object') {
        sources.push(raw);
        sources.push(raw.structuredContent);
        sources.push(raw.result);
        sources.push(raw.result?.structuredContent);
        sources.push(raw.params);
        sources.push(raw.params?.structuredContent);
        sources.push(raw.params?.result);
        sources.push(raw.params?.result?.structuredContent);
      }
      if (window.openai && window.openai.toolOutput) {
        const output = window.openai.toolOutput;
        sources.push(output);
        sources.push(output?.structuredContent);
        sources.push(output?.result);
        sources.push(output?.result?.structuredContent);
      }

      for (const candidate of sources) {
        if (isStructuredBookingPayload(candidate)) return candidate;
      }
      return null;
    }

    function parseBedConfig(config) {
      if (!config) return { beds: '–', baths: '–' };
      const beds = String(config).match(/(\d+)\s*bed/i);
      const baths = String(config).match(/(\d+)\s*bath/i);
      return { beds: beds ? beds[1] : '–', baths: baths ? baths[1] : '–' };
    }

    function formatPrice(price, currency) {
      const symbols = { USD: '$', UAH: '₴', EUR: '€' };
      const sym = symbols[currency] || currency + ' ';
      const num = Number(price);
      if (!Number.isFinite(num)) return sym + '0';
      return num >= 1000 ? sym + num.toLocaleString('en-US') : sym + num;
    }

    function formatLocationLabel(unit) {
      const loc = unit.location || {};
      const parts = [loc.city, loc.state, loc.country].filter(Boolean);
      if (parts.length) return parts.join(', ');
      return unit.hotel_name || 'Location unavailable';
    }

    function getReviewText(unit) {
      const summary = unit.review_summary || {};
      const rating = summary.rating;
      if (typeof rating === 'number' && Number.isFinite(rating)) {
        if (summary.review_count > 0) {
          return `${rating.toFixed(2)} (${summary.review_count})`;
        }
        return `${rating.toFixed(2)}`;
      }
      return 'No reviews yet';
    }

    function getDefaultDates() {
      const now = new Date();
      const day = now.getDay();
      const daysUntilFri = (5 - day + 7) % 7 || 7;
      const fri = new Date(now);
      fri.setDate(now.getDate() + daysUntilFri);
      const sun = new Date(fri);
      sun.setDate(fri.getDate() + 2);
      const fmt = d => d.toISOString().split('T')[0];
      return { check_in: fmt(fri), check_out: fmt(sun) };
    }

    function getAmenityIcon(amenity) {
      const key = String(amenity || '').toLowerCase();
      if (key.includes('wifi')) return ICONS.wifi;
      if (key.includes('kitchen') || key.includes('coffee') || key.includes('microwave') || key.includes('dishwasher') || key.includes('refrigerator')) return ICONS.kitchen;
      if (key.includes('parking') || key.includes('charger')) return ICONS.parking;
      if (key.includes('pool') || key.includes('hot tub') || key.includes('sauna')) return ICONS.water;
      if (key.includes('washer') || key.includes('dryer')) return ICONS.washer;
      if (key.includes('security') || key.includes('alarm') || key.includes('camera') || key.includes('fire') || key.includes('first aid')) return ICONS.shield;
      return ICONS.check;
    }

    function buildMapUrl(lat, lng) {
      const latNum = Number(lat);
      const lngNum = Number(lng);
      if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return '';

      const delta = 0.03;
      const left = encodeURIComponent((lngNum - delta).toFixed(6));
      const right = encodeURIComponent((lngNum + delta).toFixed(6));
      const top = encodeURIComponent((latNum + delta).toFixed(6));
      const bottom = encodeURIComponent((latNum - delta).toFixed(6));
      const marker = `${encodeURIComponent(latNum.toFixed(6))}%2C${encodeURIComponent(lngNum.toFixed(6))}`;
      return `https://www.openstreetmap.org/export/embed.html?bbox=${left}%2C${bottom}%2C${right}%2C${top}&layer=mapnik&marker=${marker}`;
    }

    function closeDetailsDialog() {
      const dialog = document.getElementById('detailsDialog');
      if (!dialog || !dialog.open) return;
      dialog.close();
      detailsUnitId = '';
      detailsThingsToKnow = {};
      detailsActiveThingTab = 'cancellation';
    }

    async function onReserve(params) {
      clearReserveError();
      const callParams = { ...params };

      if (!callParams.check_in || !callParams.check_out) {
        const defaults = getDefaultDates();
        callParams.check_in = callParams.check_in || defaults.check_in;
        callParams.check_out = callParams.check_out || defaults.check_out;
      }

      const reserveUnitId = callParams.unit_id || '';
      let reserveTimeoutId = null;
      let reserveResultPollId = null;
      let settled = false;

      setReserveButtonState(reserveUnitId, true);

      return await new Promise((resolve) => {
        const settle = (result) => {
          if (settled) return;
          settled = true;
          resolve(result);
        };

        const clearTimers = () => {
          if (reserveTimeoutId) {
            clearTimeout(reserveTimeoutId);
            reserveTimeoutId = null;
          }
          if (reserveResultPollId) {
            clearInterval(reserveResultPollId);
            reserveResultPollId = null;
          }
        };

        const finishWithError = () => {
          clearTimers();
          setReserveButtonState(reserveUnitId, false);
          showReserveError(RESERVE_CALL_ERROR_TEXT);
          settle(false);
        };

        const markReserveAccepted = () => {
          clearTimers();
          setReserveButtonState(reserveUnitId, false);
          settle(true);
        };

        reserveTimeoutId = setTimeout(() => {
          finishWithError();
        }, RESERVE_CALL_TIMEOUT_MS);

        reserveResultPollId = setInterval(() => {
          const payload = normalizeBookingPayload(null);
          if (
            payload &&
            payload.unit_id === reserveUnitId &&
            payload.check_in === callParams.check_in &&
            payload.check_out === callParams.check_out
          ) {
            markReserveAccepted();
          }
        }, 250);

        if (window.openai && window.openai.callTool) {
          Promise.resolve(window.openai.callTool('book', callParams))
            .then(markReserveAccepted)
            .catch(() => {
              finishWithError();
            });
          return;
        }

        try {
          window.parent.postMessage({
            jsonrpc: '2.0',
            method: 'tools/call',
            params: { name: 'book', arguments: callParams }
          }, '*');
        } catch (_err) {
          finishWithError();
        }
      });
    }

    async function onDetailsReserve() {
      if (!detailsUnitId) return;
      const unit = unitsById.get(detailsUnitId);
      if (!unit) return;

      const ok = await onReserve({
        unit_id: unit.id,
        check_in: currentBookingContext.check_in || '',
        check_out: currentBookingContext.check_out || '',
        guests: currentBookingContext.guests || 2,
      });

      if (ok) closeDetailsDialog();
    }

    function setThingsToKnowTab(tab) {
      detailsActiveThingTab = tab;
      const buttons = document.querySelectorAll('#detailsDialog .thing-tab');
      buttons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      const panel = document.getElementById('thingContent');
      if (!panel) return;

      const contentMap = {
        cancellation: detailsThingsToKnow.cancellation || 'No cancellation details yet.',
        house_rules: detailsThingsToKnow.house_rules || 'No house rules details yet.',
        safety: detailsThingsToKnow.safety || 'No safety details yet.',
      };

      panel.innerHTML = formatMultilineText(contentMap[tab] || contentMap.cancellation);
    }

    function buildCard(unit, bookingContext) {
      const { beds, baths } = parseBedConfig(unit.bed_config);
      const imgUrl = sanitizeUrl(unit.image_url || (unit.images && unit.images[0]) || '');
      const priceDisplay = formatPrice(unit.price_per_night, unit.currency_code);
      const hotelName = unit.hotel_name || '';
      const unitType = unit.type || '';
      const maxGuests = unit.max_guests || '';

      const reserveParams = {
        unit_id: unit.id,
        check_in: bookingContext.check_in || '',
        check_out: bookingContext.check_out || '',
        guests: bookingContext.guests || 2,
      };

      return `
        <article class="room-card" data-unit-id="${escapeHtml(unit.id)}">
          <div class="room-media">
            ${imgUrl ? `<style>.room-card[data-unit-id="${escapeHtml(unit.id)}"] .room-media::before{background-image:url('${imgUrl}');}</style>` : ''}
            ${unitType ? `<span class="type-badge">${escapeHtml(unitType)}</span>` : ''}
            ${maxGuests ? `<span class="guests-badge">${ICONS.guest} Up to ${escapeHtml(maxGuests)}</span>` : ''}
            <div class="content">
              <div>
                <h1 class="title">${escapeHtml(unit.name)}</h1>
                ${hotelName ? `<p class="subtitle">${escapeHtml(hotelName)}</p>` : ''}
              </div>

              <div class="amenities">
                <span class="item">${ICONS.bed} Beds: <strong>${escapeHtml(beds)}</strong></span>
                <span class="divider"></span>
                <span class="item">${ICONS.bath} Baths: <strong>${escapeHtml(baths)}</strong></span>
              </div>

              <div class="cta-row">
                <div class="price-pill">${escapeHtml(priceDisplay)}</div>
                <div class="cta-buttons">
                  <button class="details" type="button" aria-label="More details for ${escapeHtml(unit.name)}" onclick="onMoreDetails('${escapeHtml(unit.id)}')">More details</button>
                  <button class="reserve" type="button" aria-label="Reserve ${escapeHtml(unit.name)}" onclick='onReserve(${JSON.stringify(reserveParams)})'>Reserve</button>
                </div>
              </div>
            </div>
          </div>
        </article>`;
    }

    function renderDetailsDialog(unit) {
      const dialogBody = document.getElementById('detailsDialogContent');
      if (!dialogBody) return;

      detailsUnitId = unit.id;
      detailsThingsToKnow = unit.things_to_know || {};
      detailsActiveThingTab = 'cancellation';

      const allImages = (unit.images || []).map(sanitizeUrl).filter(Boolean);
      const primaryImage = allImages[0] || sanitizeUrl(unit.image_url) || '';
      const sideImageOne = allImages[1] || primaryImage;
      const sideImageTwo = allImages[2] || sideImageOne || primaryImage;

      const reviewText = getReviewText(unit);
      const locationLabel = formatLocationLabel(unit);

      const amenities = (unit.amenities || []).slice(0, 16);
      const amenitiesMarkup = amenities.length
        ? amenities.map((amenity) => `<div class="amenity-item">${getAmenityIcon(amenity)}<span>${escapeHtml(amenity)}</span></div>`).join('')
        : '<p class="details-empty">No amenities listed yet.</p>';

      const reviews = Array.isArray(unit.extended_reviews) ? unit.extended_reviews : [];
      const reviewsMarkup = reviews.length
        ? `<div class="reviews-list">${reviews.map((review) => {
            const ratingPart = typeof review.rating === 'number' ? `${review.rating.toFixed(1)} ★` : '—';
            return `<article class="review-card">
              <div class="review-head">
                <div class="review-author">${escapeHtml(review.author || 'Guest')}</div>
                <div class="review-meta">${escapeHtml(review.date || '')} · ${escapeHtml(ratingPart)}</div>
              </div>
              <p class="review-comment">${escapeHtml(review.comment || '')}</p>
            </article>`;
          }).join('')}</div>`
        : '<p class="details-empty">No reviews yet.</p>';

      const mapInfo = unit.map || {};
      const mapUrl = buildMapUrl(mapInfo.lat, mapInfo.lng);
      const mapMarkup = mapUrl
        ? `<div class="map-wrap"><iframe title="Property map" src="${mapUrl}" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>`
        : `<p class="details-empty">Map is unavailable for this listing.</p>`;

      const host = unit.host || {};
      const hostAvatar = sanitizeUrl(host.avatar_url) || '';

      dialogBody.innerHTML = `
        <div class="details-header">
          <div>
            <h2 class="details-title">${escapeHtml(unit.name || 'Room details')}</h2>
            <p class="details-subtitle">${escapeHtml(locationLabel)}</p>
          </div>
          <button class="close" type="button" aria-label="Close details" onclick="closeDetailsDialog()">Close</button>
        </div>

        <section aria-label="Images">
          <div class="details-gallery">
            <div class="details-gallery-main">${primaryImage ? `<img src="${primaryImage}" alt="${escapeHtml(unit.name || 'Property image')}" />` : ''}</div>
            <div class="details-gallery-side">
              <div class="details-gallery-side-item">${sideImageOne ? `<img src="${sideImageOne}" alt="${escapeHtml(unit.name || 'Property side image 1')}" />` : ''}</div>
              <div class="details-gallery-side-item">${sideImageTwo ? `<img src="${sideImageTwo}" alt="${escapeHtml(unit.name || 'Property side image 2')}" />` : ''}</div>
            </div>
          </div>
        </section>

        <section class="details-section" aria-label="Description">
          <h3>Description</h3>
          <p class="details-description">${escapeHtml(unit.description || 'No description yet.')}</p>
        </section>

        <section class="details-section" aria-label="Short review">
          <h3>Reviews</h3>
          <div class="review-inline">${ICONS.star}<span>${escapeHtml(reviewText)}</span></div>
        </section>

        <section class="details-section" aria-label="Amenities">
          <h3>What this place offers</h3>
          <div class="amenities-grid">${amenitiesMarkup}</div>
        </section>

        <section class="details-section" aria-label="Extended reviews">
          <h3>Extended reviews</h3>
          ${reviewsMarkup}
        </section>

        <section class="details-section" aria-label="Map section">
          <h3>Map</h3>
          <p class="details-subtitle" style="margin: 0 0 12px 0;">${escapeHtml(mapInfo.label || locationLabel)}</p>
          ${mapMarkup}
        </section>

        <section class="details-section" aria-label="Meet your host">
          <h3>Meet your host</h3>
          <div class="host-grid">
            <div class="host-card">
              <div class="host-id">
                ${hostAvatar ? `<img class="host-avatar" src="${hostAvatar}" alt="Host avatar" />` : '<div class="host-avatar" aria-hidden="true"></div>'}
                <div>
                  <p class="host-name">${escapeHtml(host.name || unit.hotel_name || 'Host')}</p>
                  <p class="host-small">Host</p>
                </div>
              </div>
              <div class="host-badges">
                <span class="host-badge">${escapeHtml(String(host.years_hosting || 1))} year hosting</span>
                ${host.is_superhost ? '<span class="host-badge">Superhost</span>' : ''}
              </div>
            </div>
            <div class="host-meta-card">
              <p class="host-name" style="font-size: 28px; margin-bottom: 8px;">Host details</p>
              <p class="details-description" style="font-size: 16px;">${escapeHtml(host.response_time || 'Responds within a few days or more')}</p>
            </div>
          </div>
        </section>

        <section class="details-section" aria-label="Things to know">
          <h3>Things to know</h3>
          <div class="things-tabs">
            <button class="thing-tab active" type="button" data-tab="cancellation" onclick="setThingsToKnowTab('cancellation')">Cancellation policy</button>
            <button class="thing-tab" type="button" data-tab="house_rules" onclick="setThingsToKnowTab('house_rules')">House rules</button>
            <button class="thing-tab" type="button" data-tab="safety" onclick="setThingsToKnowTab('safety')">Safety & property</button>
          </div>
          <div id="thingContent" class="thing-content"></div>
        </section>

        <div class="details-reserve-row">
          <button id="detailsReserveBtn" class="details-reserve" type="button" onclick="onDetailsReserve()">Reserve</button>
        </div>
      `;

      setThingsToKnowTab(detailsActiveThingTab);
    }

    function onMoreDetails(unitId) {
      const unit = unitsById.get(unitId);
      if (!unit) return;

      renderDetailsDialog(unit);
      const dialog = document.getElementById('detailsDialog');
      if (!dialog) return;
      if (!dialog.open) dialog.showModal();
    }

    function render(data) {
      const units = data.units || [];
      currentUnits = units;
      unitsById = new Map(units.map((u) => [u.id, u]));
      currentBookingContext = {
        check_in: data.check_in || '',
        check_out: data.check_out || '',
        guests: data.guests || 2,
      };

      if (!units.length) {
        document.getElementById('root').innerHTML = '<div id="loading">No rooms found matching your criteria.</div>';
        return;
      }

      document.getElementById('root').innerHTML =
        '<div class="cards-container">' +
        units.map((unit) => buildCard(unit, currentBookingContext)).join('') +
        '</div>';

      clearReserveError();
    }

    const HYDRATION_TIMEOUT_MS = 5000;
    const HYDRATION_POLL_MS = 250;
    const HYDRATION_MAX_POLLS = 20;

    function isStructuredRoomPayload(data) {
      return !!data && typeof data === 'object' && Array.isArray(data.units);
    }

    function normalizeToolPayload(raw) {
      const sources = [];

      if (raw && typeof raw === 'object') {
        sources.push(raw);
        sources.push(raw.structuredContent);
        sources.push(raw.result);
        sources.push(raw.result?.structuredContent);
        sources.push(raw.params);
        sources.push(raw.params?.structuredContent);
        sources.push(raw.params?.result);
        sources.push(raw.params?.result?.structuredContent);
      }
      if (window.openai && window.openai.toolOutput) {
        const output = window.openai.toolOutput;
        sources.push(output);
        sources.push(output?.structuredContent);
        sources.push(output?.result);
        sources.push(output?.result?.structuredContent);
      }

      for (const candidate of sources) {
        if (isStructuredRoomPayload(candidate)) return candidate;
      }
      return null;
    }

    function clearHydrationTimers() {
      if (hydrationTimeoutId) {
        clearTimeout(hydrationTimeoutId);
        hydrationTimeoutId = null;
      }
      if (hydrationPollId) {
        clearInterval(hydrationPollId);
        hydrationPollId = null;
      }
    }

    function hydrate(raw) {
      if (hydrated) return true;
      const payload = normalizeToolPayload(raw);
      if (!payload) return false;

      hydrated = true;
      clearHydrationTimers();
      render(payload);
      return true;
    }

    function showLoadError() {
      if (hydrated) return;
      document.getElementById('root').innerHTML =
        '<div id="loading">Unable to load rooms. Please retry.<br><button class="retry-btn" type="button" onclick="retryHydration()">Retry</button></div>';
    }

    function probeHydrationSources() {
      if (hydrated) return true;
      if (window.openai && hydrate(window.openai.toolOutput)) return true;
      if (window.openai && typeof window.openai.getToolResult === 'function') {
        Promise.resolve(window.openai.getToolResult())
          .then(hydrate)
          .catch(() => {});
      }
      return hydrated;
    }

    function startHydrationChecks() {
      clearHydrationTimers();
      probeHydrationSources();

      let polls = 0;
      hydrationPollId = setInterval(() => {
        polls += 1;
        if (probeHydrationSources() || polls >= HYDRATION_MAX_POLLS) {
          clearInterval(hydrationPollId);
          hydrationPollId = null;
        }
      }, HYDRATION_POLL_MS);

      hydrationTimeoutId = setTimeout(showLoadError, HYDRATION_TIMEOUT_MS);
    }

    function retryHydration() {
      if (hydrated) return;
      document.getElementById('root').innerHTML = '<div id="loading">Retrying...</div>';
      startHydrationChecks();
    }

    window.retryHydration = retryHydration;
    window.onMoreDetails = onMoreDetails;
    window.onDetailsReserve = onDetailsReserve;
    window.closeDetailsDialog = closeDetailsDialog;
    window.setThingsToKnowTab = setThingsToKnowTab;

    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== 'object') return;
      if (msg.jsonrpc !== '2.0' || msg.method !== 'ui/notifications/tool-result') return;
      if (normalizeBookingPayload(msg)) {
        clearReserveError();
      }
      hydrate(msg);
    });

    const detailsDialog = document.getElementById('detailsDialog');
    if (detailsDialog) {
      detailsDialog.addEventListener('click', (event) => {
        if (event.target === detailsDialog) closeDetailsDialog();
      });
    }

    startHydrationChecks();
  </script>
</body>
</html>
